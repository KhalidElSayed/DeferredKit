<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>DeferredKit: DKDeferred - Deferred objects for Objective-C</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.6.1 -->
<script type="text/javascript">
<!--
function changeDisplayState (e){
  var num=this.id.replace(/[^[0-9]/g,'');
  var button=this.firstChild;
  var sectionDiv=document.getElementById('dynsection'+num);
  if (sectionDiv.style.display=='none'||sectionDiv.style.display==''){
    sectionDiv.style.display='block';
    button.src='open.gif';
  }else{
    sectionDiv.style.display='none';
    button.src='closed.gif';
  }
}
function initDynSections(){
  var divs=document.getElementsByTagName('div');
  var sectionCounter=1;
  for(var i=0;i<divs.length-1;i++){
    if(divs[i].className=='dynheader'&&divs[i+1].className=='dynsection'){
      var header=divs[i];
      var section=divs[i+1];
      var button=header.firstChild;
      if (button!='IMG'){
        divs[i].insertBefore(document.createTextNode(' '),divs[i].firstChild);
        button=document.createElement('img');
        divs[i].insertBefore(button,divs[i].firstChild);
      }
      header.style.cursor='pointer';
      header.onclick=changeDisplayState;
      header.id='dynheader'+sectionCounter;
      button.src='closed.gif';
      section.id='dynsection'+sectionCounter;
      section.style.display='none';
      section.style.marginLeft='14px';
      sectionCounter++;
    }
  }
}
window.onload = initDynSections;
-->
</script>
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li class="current"><a href="main.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="annotated.html"><span>Data&nbsp;Structures</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
</div>
<div class="contents">
<h1>DKDeferred - Deferred objects for Objective-C</h1><h3>0.2 </h3><p>DeferredKit is an asynchronous library for cocoa built around the idea of a <a href="http://twistedmatrix.com/projects/core/documentation/howto/defer.html">Deferred Object</a> - that is, "an object created to encapsulate a sequence of callbacks in response to an object that may not yet be available." Besides the core class, <a class="el" href="class_d_k_deferred.html">DKDeferred</a>, much other functionality is included in this project, including an asynchronous URL loading API, an asynchronous disk cache, and a JSON-RPC implementation.</p>
<p>DeferredKit is modeled after the deferred class by <a href="http://twistedmatrix.com/">TwistedMatrix</a> and inspired by <a href="http://www.mochikit.com/doc/html/MochiKit/Async.html#fn-deferred">MochiKit's</a> implementation of Deferred. <a class="el" href="interface_d_k_callback.html">DKCallback</a> - the function object is mostly taken from a pre-blocks version of <a href="http://github.com/mogeneration/functionalkit">FunctionalKit</a>.</p>
<p>The <a class="el" href="class_d_k_deferred.html">DKDeferred</a> implementation is not dependent upon threads or any other form of concurrency for it's operation (however, you may create threaded Deferred's) and operates in the same environment as the rest of your Objective-C program.</p>
<p><b>NOTE:</b> DeferredKit bundles <a href="http://code.google.com/p/json-framework/">json-framework</a>, and will need to be removed from your project before adding DeferredKit using the following method. Otherwise, embedding the code works just as well.</p>
<p>More: 1. <a href="http://samuraiblog.com/wordpress/2009/11/06/json-rpc-in-objective-c/">JSON-RPC in Objective-C</a></p>
<h2>Installing DeferredKit</h2>
<ol>
<li>
Copy the entire source tree into your projects directory. </li>
<li>
<p class="startli">Add DeferredKit to your project.</p>
<ul>
<li>
Copy <code>"{PROJECT_ROOT}/DeferredKit/CocoaDeferred/CocoaDeferred.xcodeproj"</code> </li>
<li>
In the window presented by Xcode, uncheck "Copy items...". Reference type should be "Relative to Project" </li>
<li>
Uncheck any targets Xcode might automatically assume. </li>
</ul>
</li>
<li>
<p class="startli">Add DeferredKit to your header search paths.</p>
<ul>
<li>
Under your target's build settings, search for find "Header Search Paths" and add <code>"DeferredKit/CocoaDeferred/Source"</code> </li>
</ul>
</li>
<li>
<p class="startli">Add DeferredKit to your Target</p>
<ul>
<li>
Under your target's general settings, under Direct Dependancies click the "+" button and choose "DeferredKit" </li>
</ul>
</li>
<li>
Expand your <code>"CocoaDeferred.xcodeproj"</code> and drag <code>"libDeferredKit.a"</code> to your target's "Link Binary with Library" </li>
</ol>
<h2>Example Usage</h2>
<h3>Asynchronous URL Loading</h3>
<p>All methods in DeferredKit return Deferred objects. This is the same basic interface used to access all functionality provided by DeferredKit.</p>
<pre><code></p>
<div class="fragment"><pre class="fragment"> <span class="keywordtype">id</span> cbGotResource(<span class="keywordtype">id</span> results) {
    [[Resource resourceWithData:results] save];
    <span class="keywordflow">return</span> nil;
  }

  <span class="keywordtype">id</span> cbGetResourceFailed(<span class="keywordtype">id</span> error) {
    <span class="comment">// alert user resource is unavailable.</span>
    <span class="keywordflow">return</span> nil;
  }

  <a class="code" href="class_d_k_deferred.html">DKDeferred</a> *d = [<a class="code" href="class_d_k_deferred.html">DKDeferred</a> loadURL:<span class="stringliteral">@&quot;http://addr.net/resource/&quot;</span>];
  [d addCallback:<a class="code" href="_d_k_callback_8h.html#a10ff68c10c11609cd8df0e7b712745f8">callbackP</a>(cbGotResource)];
  [d addCallback:<a class="code" href="_d_k_callback_8h.html#a10ff68c10c11609cd8df0e7b712745f8">callbackP</a>(cbGetResourceFailed)];
</pre></div><p></code></pre><h3>Asynchronous processing</h3>
<p>You can generate Deferred objects which encapsulate the execution of a method or function in a thread. The Deferred automatically returns the result to the correct thread.</p>
<pre><code></p>
<div class="fragment"><pre class="fragment"> <span class="keywordtype">id</span> cbDoneProcessing(<span class="keywordtype">id</span> results) {
    <span class="keywordflow">if</span> (content) {
      [content release];
      content = nil;
    }
    content = [results retain];
    [tableView reloadData];
    <span class="keywordflow">return</span> nil;
  }

  DKDefered *d =[<a class="code" href="class_d_k_deferred.html">DKDeferred</a> deferInThread:
                 <a class="code" href="_d_k_callback_8h.html#afdbbdadada65132837fa9f49129c8196">callbackTS</a>((<span class="keywordtype">id</span>)[Resource <span class="keyword">class</span>], updateAllResources:)];
  [d addCallback:cbDoneProcessing];
</pre></div><p></code></pre><h3>Combining Asynchronous tasks</h3>
<p>These two Deferred objects may return almost immediately if loaded from the cache.</p>
<pre><code></p>
<div class="fragment"><pre class="fragment"> - (IBAction)loadResource:(<span class="keywordtype">id</span>)sender {
    <a class="code" href="class_d_k_deferred.html">DKDeferred</a> *html = [<a class="code" href="class_d_k_deferred.html">DKDeferred</a> loadURL:<span class="stringliteral">@&quot;http://url1.com/resource&quot;</span> cached:YES];
    <a class="code" href="class_d_k_deferred.html">DKDeferred</a> *header = [<a class="code" href="class_d_k_deferred.html">DKDeferred</a> loadImage:<span class="stringliteral">@&quot;http://url1.com/resource-img.png&quot;</span> cached:YES];

    <a class="code" href="class_d_k_deferred.html">DKDeferred</a> *d = [<a class="code" href="class_d_k_deferred.html">DKDeferred</a> gatherResults:array_(html, header)];
    [d addCalback:<a class="code" href="_d_k_callback_8h.html#afdbbdadada65132837fa9f49129c8196">callbackTS</a>(<span class="keyword">self</span>, cbDoneLoading:)];
  }

  - (id)cbDoneLoading:(<span class="keywordtype">id</span>)results {
    [<span class="keyword">self</span> showHTML:[results objectAtIndex:0]];
    [<span class="keyword">self</span> showHeaderImage:[results objectAtIndex:1]];
    <span class="keywordflow">return</span> nil;
  }
</pre></div><p></code></pre><h3>Interacting with a JSON-RPC Service</h3>
<p>DeferredKit provides a JSON-RPC implementation using <a class="el" href="class_d_k_deferred.html">DKDeferred</a>.</p>
<pre><code></p>
<div class="fragment"><pre class="fragment"> <span class="keywordtype">id</span> myservice = [<a class="code" href="class_d_k_deferred.html">DKDeferred</a> jsonService:<span class="stringliteral">@&quot;&quot;</span> name:<span class="stringliteral">@&quot;myservice&quot;</span>]
  <a class="code" href="class_d_k_deferred.html">DKDeferred</a> *d = [myservice someMethod:array(arg1, arg2)]
  [d addCallbacks:<a class="code" href="_d_k_callback_8h.html#afdbbdadada65132837fa9f49129c8196">callbackTS</a>(<span class="keyword">self</span>, cbGotResults:) :<a class="code" href="_d_k_callback_8h.html#afdbbdadada65132837fa9f49129c8196">callbackTS</a>(cbGetResultsFailed:)];
</pre></div><p></code></pre><h3>Asynchronous processing chain</h3>
<p>Each callback added to a <a class="el" href="class_d_k_deferred.html">DKDeferred</a> results in a chain of callbacks - the last callback added will be called with the result returned by the previous callback.</p>
<pre><code></p>
<div class="fragment"><pre class="fragment"> - (IBAction)fetchResources:(<span class="keywordtype">id</span>)sender {
    <span class="keywordtype">id</span> _parseResults:(<span class="keywordtype">id</span> results) {
      <span class="comment">// _parseResults can return an NSError at which point the deferred</span>
      <span class="comment">// will begin it&apos;s error callback chain</span>
      <span class="keywordflow">return</span> [Resource arrayWithJSONResponse:results];
    }

    <a class="code" href="class_d_k_deferred.html">DKDeferred</a> *d = [<a class="code" href="class_d_k_deferred.html">DKDeferred</a> loadJSONDoc:<span class="stringliteral">@&quot;http://whereitsat.net/resource/&quot;</span>]
    [d addCallback:<a class="code" href="_d_k_callback_8h.html#a10ff68c10c11609cd8df0e7b712745f8">callbackP</a>(_parseResults)];
    [d addCallback:<a class="code" href="_d_k_callback_8h.html#afdbbdadada65132837fa9f49129c8196">callbackTS</a>(<span class="keyword">self</span>, _presentResources:)];
    [d addErrback:<a class="code" href="_d_k_callback_8h.html#afdbbdadada65132837fa9f49129c8196">callbackTS</a>(<span class="keyword">self</span>, _getResourcesFailed:)];
  }

  - (id)_presentResources:(<span class="keywordtype">id</span>)results {
    <span class="keywordflow">if</span> (resources) {
      [resources release];
      resources = nil;
    }
    resources = [results retain];
    [tableView reloadData];
  }
</pre></div><p></code></pre><h3>Asynchronous disk cache</h3>
<p>Since the disk cache utilizes a deferred object interface, access to cached results can implement caching in only a few lines.</p>
<pre><code></p>
<div class="fragment"><pre class="fragment"> - (IBAction)fetchSomeStuff:(<span class="keywordtype">id</span>)sender {
    <span class="keywordtype">id</span> _gotKey(<span class="keywordtype">id</span> results) {
      <span class="keywordflow">if</span> (results == [NSNull null]) { <span class="comment">// cache miss</span>
        <span class="keywordflow">return</span> [<a class="code" href="class_d_k_deferred.html">DKDeferred</a> deferInThread:[Resource getResources] withObject:nil];
      } <span class="keywordflow">else</span> { <span class="comment">// cache hit</span>
        <span class="keywordflow">return</span> results;
      }
    }
    <a class="code" href="class_d_k_deferred.html">DKDeferred</a> *d = [[<a class="code" href="interface_d_k_deferred_cache.html">DKDeferredCache</a> sharedCache] valueForKey:<span class="stringliteral">@&quot;someKey&quot;</span>];
    [d addCallback:<a class="code" href="_d_k_callback_8h.html#a10ff68c10c11609cd8df0e7b712745f8">callbackP</a>(_gotKey)];
    [d addCallback:<a class="code" href="_d_k_callback_8h.html#afdbbdadada65132837fa9f49129c8196">callbackTS</a>(<span class="keyword">self</span>, cbGotResults:)];
  }

  - (id)cbGotResults:(<span class="keywordtype">id</span>)results {
    <span class="keywordflow">if</span> (isDeferred(results)) <span class="comment">// in the event of a cache miss</span>
      <span class="keywordflow">return</span> [results addCallback:<a class="code" href="_d_k_callback_8h.html#afdbbdadada65132837fa9f49129c8196">callbackTS</a>(<span class="keyword">self</span>, cbGotResults:)];
    <span class="keywordflow">if</span> (resources) {
      [resources release];
      resources = nil;
    }
    resources = [results retain];
    [tableView reloadData];
  }
</pre></div><p></code></pre> </div>
<hr size="1"/><address style="text-align: right;"><small>Generated on Wed Nov 18 04:51:54 2009 for DeferredKit by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.6.1 </small></address>
</body>
</html>
